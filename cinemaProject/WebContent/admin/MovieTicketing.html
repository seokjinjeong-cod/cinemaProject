<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
			font-family: 'Jua', sans-serif;
		}
		h1 {
			text-align: center;
			margin-top: 5%;
		}
		body {
			height: 100%;
			width: 100%;
			background-image: url(../seokjin/login/img/film-596009.jpg);
			background-position: center;
			background-size: cover;
			position: absolute;
		}
		#showposter {
			margin: 10px;

		}

		#showtitle {
			text-align: center;
			float: block;

		}

		section {
			/* position: absolute;
			left: 50%; top: 50%; */
			border: 1px solid black;
			width: 300px;
			height: 500px;
			float: left;
			text-align: center;
		}

		#button {
			float: right;
		}
		aside {
			float: right;
		}
	</style>
</head>

<body>
	<button id="button" class="menu" onclick="logOut()">로그아웃</button>
	<button id="button" class="menu" onclick="ticketCheck()">예약정보</button>
	<aside>
		<div id="ticketCheck">
			<ul id="divToggle"></ul>
		</div>
	</aside>
	<div id="showmovie">
		<h1>현재상영작</h1>
	
	</div>

	<script>
		let link = document.location.href;
        console.log(link.split('=')[1]);
        let userId = link.split('=')[1];
        console.log(userId);

		function logOut() {
			window.location.href='../seokjin/login/login_resist_form.html';
		}

		// $(function() {
		// 	$('#button').click(function() {
		// 		$('#ticketCheck').empty();

		// 		let p = ('<p />');
		// 		p.html()
		// 	});
		// });

		function ticketCheck() {
			console.log(userId);
			
			let xhtp = new XMLHttpRequest();
			xhtp.onload = function() {
				let data = JSON.parse(xhtp.responseText);
				console.log(data);
				// console.log(data.length);
				if(data.length == 0) {
					window.alert("예약정보가 없습니다.");
					return;
				}

				$('#divToggle').empty();
				for(let ticket of data) {
					console.log(ticket);
					let ticketInfo = $('<li/>').html(ticket.title + ',' + 
												  ticket.ticketDate + ',' + 
												  ticket.location + ',' + 
												  ticket.time + ',' + 
												  ticket.seatNum);
					$('ul').append(ticketInfo);
				}
				$('#divToggle').toggle();


			}
			xhtp.open('post', '../MemberServlet');
			xhtp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xhtp.send('userId=' + userId + '&cmd=ticket')
		};
		


		$.ajax({
			url: '../GetScreenInfo',
			tyoe: 'get',
			dataType: 'json',
			success: function (result) {
				//성공화면
				console.log(result);
				userShowMovie(result)
			},
			error: function () {
				//에러화면
			}
		});

		function userShowMovie(result) {
			let title = [];
			let location = [];
			for (let field in result) {
				title.push(result[field].title);
				// let startdate=result[field].startdate;
				location.push(result[field].location);
				// let location=result[field].location;
				// let screentime=result[field].screentime;
				// let img = result[field].img;
				// let seatcnt=result[field].seatcnt;
				// console.log(title,startdate,location,screentime,img,seatcnt);
			}
			let img;
			let uniqueTitle = uniqueFnc(title);
			let uniqueLocation = uniqueFnc(location);
			let select
			let i = 0;
			for (let field in result) {
				if (uniqueTitle[i] == result[field].title) {
					img = result[field].img;
					let section = document.createElement("section")
					section.id = 'section' + result[field].title + ',' + result[field].startdate + ',' + result[field].location +
					'';
					let div = document.createElement("div");
					let outerdiv = document.getElementById('showmovie');
					div.id = 'showtitle';
					div.innerHTML = uniqueTitle[i];
					section.appendChild(div);
					div = document.createElement('div');
					div.id = 'showposter';
					div.style.float = 'left';
					div.innerHTML = '<img width="200px" height="300px" ; src="../upload/' + img + '">';
					div.setAttribute('onclick', 'movieSelect(event)');
					section.appendChild(div);
					let dateInput = document.createElement('input');
					// dateInput.id='watchingDate';
					dateInput.type = 'text';
					section.appendChild(dateInput);
					dateInput.setAttribute('type', 'date');
					dateInput.id = 'showDate';
					select = document.createElement('select');

					for (let field in uniqueLocation) {
						let option = document.createElement('option');
						option.id = 'showLoacation';
						option.innerHTML = uniqueLocation[field];
						select.appendChild(option);
					}
					let submitBtn = document.createElement('button');
					submitBtn.innerHTML = '조회';
					submitBtn.setAttribute('onclick', 'showMovieList(event)');
					section.appendChild(select);
					section.appendChild(submitBtn);
					outerdiv.appendChild(section);
					i++;
					if (i == uniqueTitle.length)
						break;
				}
			}


			console.log(img);
		}

		function showMovieList(e) {
			e.preventDefault();
			let title = e.target.parentNode.childNodes[0].firstChild.nodeValue;
			let date = e.target.parentNode.childNodes[2].value;
			let location = e.target.parentNode.childNodes[3].value;
			$.ajax({
				url: '../ShowScreenServ',
				type: 'GET',
				data: "title=" + title + "&date=" + date + "&location=" + location + "",
				processData: false,
				contentType: false,
				dataType: 'json',
				success: function (result) {
					alert('성공');
					//	$('#frm>input').not('[type="submit"]').val('');
					for (let obj of result) {
						let div = document.createElement('div');
						div.setAttribute('onclick', 'seatFnc(event)');
						div.id = '"' + obj.screentime + '"';
						div.innerHTML = obj.screentime;
						let sectionTag = document.getElementById('section' + title + ',' + date + ',' + location + '');
						sectionTag.appendChild(div);
					}
				},
				error: function () {
					alert('실패');
				}
			});
		}

		function seatFnc(e) {
			e.preventDefault();
			console.log(e.target);
			let table = document.createElement('table');
			table.setAttribute('border', '1px');
			table.style.textAlign = 'center';
			table.style.width = '500px';
			table.style.height = '400px';
			// table.style.display = 'none';
			let tbody = document.createElement('tbody');
			let tr;
			tr = document.createElement('tr');
			for (let i = 1; i <= 80; i++) {
				let td = document.createElement('td');
				td.setAttribute('onclick', 'seatSelect(event)');

				td.innerHTML = i;
				td.id = 'seat' + i;
				if (i % 10 != 0) {
					tr.appendChild(td);

				} else {
					tr.appendChild(td);
					tr = document.createElement('tr');
				}
				tbody.appendChild(tr);
			}
			table.appendChild(tbody);

			let div = e.target;
			div.appendChild(table);
		}

		//좌석 선택시 색변경
		function seatSelect(e) {
			let divTag=e.target.parentNode.parentNode.parentNode.parentNode;
			divTag.setAttribute('onclick','');
			let tdTar = e.target;
			if (tdTar.style.backgroundColor == '') {
				tdTar.style.backgroundColor = 'red';
			} else {
				tdTar.style.backgroundColor = '';
			}
		}

		function uniqueFnc(obj) {
			let uniqueArr = [];
			obj.forEach((e) => {
				if (!uniqueArr.includes(e)) {
					uniqueArr.push(e);
				}
			});
			return uniqueArr;
		}
	</script>
</body>

</html>